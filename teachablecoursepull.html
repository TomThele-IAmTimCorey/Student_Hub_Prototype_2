<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Course Validation</title>
  
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    header, footer { background-color: #222; color: white; padding: 15px; text-align: center; }
    .container { padding: 20px; }
    h2 { margin-top: 40px; }
    .badges img { height: 100px; margin-right: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: left; }
    button { padding: 6px 12px; }
    .bento-wrapper {
      background: #39bad8;
      border-radius: 24px;
      padding: 32px 16px;
      margin-top: 32px;
      margin-bottom: 32px;
      box-shadow: 0 4px 16px rgba(57,186,216,0.10);
    }
    .bento-box {
      background: #f8f8f8;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      padding: 24px;
      margin-top: 16px;
      margin-bottom: 32px;
    }
    .bento-row {
      display: flex;
      gap: 24px;
      margin-bottom: 32px;
    }
    .bento-box-2-3 {
      flex: 2 1 0;
      min-width: 0;
      display: flex;
      flex-direction: column;
      justify-content: stretch;
    }
    .bento-box-1-3 {
      flex: 1 1 0;
      min-width: 0;
      display: flex;
      flex-direction: column;
      justify-content: stretch;
    }
    .video-thumbs {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: flex-start;
      align-items: flex-start;
    }
    .video-thumb {
      text-align: center;
      width: 200px;
    }
    .video-thumb img {
      width: 100%;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.10);
      margin-bottom: 8px;
    }
    /* Scrollable table for courses */
    .scrollable-table {
      max-height: 400px;
      overflow-y: auto;
      margin-top: 10px;
    }
    @media (max-width: 900px) {
      .bento-row { flex-direction: column; }
      .bento-box-2-3, .bento-box-1-3 { width: 100%; }
    }
    @media (max-width: 700px) {
      .video-thumbs { flex-direction: column; align-items: stretch; }
      .video-thumb { width: 100%; }
    }
            body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
            color: #333;
        }
        .post {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        .post h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        .post .meta {
            font-size: 0.9em;
            color: #888;
            margin-bottom: 20px;
        }
        .post .content {
            line-height: 1.6;
        }
        
        /* Simple CSS spinner */
        .spinner {
        margin: 0 auto 10px auto;
        border: 6px solid #f3f3f3;
        border-top: 6px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        }
        @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
        }

  </style>
</head>
<body>
  <header>
    <h1>Student Course Validation</h1>
    
  </header>


  <div class="container">
    <h2 id="welcomeText">Welcome In</h2>

    <div class="bento-wrapper">


      <!-- Section 1: Badges -->
      <div class="bento-box">
        <h2>Issued Badges </h2>

        <br>
        <br>
        <button class="btn btn-success" onclick="window.open('https://badgecert.com/login','_blank')">
          Login to BadgeCert
        </button>
        <span>Log into your profile to share your badges on social media!</span>
        <br><br>
        <a href="badge.html">
          <button style="padding:10px 20px; font-size:16px; border-radius:6px; cursor:pointer; color: darkcyan;">
          View My Badges (LIVE)
          </button>
        </a>
      </div>


      <!-- Section 2: Courses -->
      <div class="bento-box">
        <h2>The Students Courses V4</h2>
        <!-- Email input above table -->
            <div style="margin-bottom: 1em;">
            <label for="loginEmailInput">Login Email:</label>
            <input type="text" id="loginEmailInput" placeholder="Enter your login email" />
            <button id="loadBtn">Load Courses</button>
            </div>
            <!-- Spinner graphic -->
            <div id="loadingSpinner" style="display:none; text-align:center; margin:20px;">
                <div class="spinner"></div>
                <p>Loading courses from Teachable...</p>
            </div>
        <div class="scrollable-table">
          <div id="coursesContainer"></div>
        </div>
        <div>
          <h4>Scroll to see more courses</h4>
          
        </div>
      </div>
        <!-- Spinner graphic -->
        <div id="loadingSpinner" style="display:none; text-align:center; margin:20px;">
            <div class="spinner"></div>
            <p>Loading courses from Teachable...</p>
        </div>
    </div> 
  </div>



    <!---------------------------  
        Teachable API integration
        -------------------------  
    -->
<!--
hoUy238I3tditABq22vkjWxEUoylKigb
-->


<script>
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById('welcomeText').textContent =
    "Welcome In, " + (localStorage.getItem('login_name') || "Student");

  const apiKey = "hoUy238I3tditABq22vkjWxEUoylKigb";

  const spinner = document.getElementById("loadingSpinner");
  const emailInput = document.getElementById("loginEmailInput");

  // ✅ Get email from URL parameter "student_email"
  const urlParams = new URLSearchParams(window.location.search);
  const urlEmail = urlParams.get("student_email") || "";

  // Prefill input with URL email if provided
  emailInput.value = urlEmail;

  async function loadCourses() {
    const loginEmail = emailInput.value.trim();
    if (!loginEmail) {
      alert("Please enter a login email.");
      return;
    }

    const container = document.getElementById('coursesContainer');
    container.innerHTML = "Loading courses...";

    console.log(`Starting API call for ${loginEmail}`);

    try {
      // Step 1: Get studentId by email
      const userResponse = await fetch(
        `https://developers.teachable.com/v1/users?email=${encodeURIComponent(loginEmail)}`,
        {
          method: "GET",
          headers: {
            "accept": "application/json",
            "apiKey": apiKey   // ✅ corrected header
          }
        }
      );

      if (!userResponse.ok) {
        throw new Error("User lookup failed: " + userResponse.status);
      }

      const userData = await userResponse.json();
      if (!userData.users || userData.users.length === 0) {
        throw new Error("No user found for email " + loginEmail + ". Consider getting Free Course - Hands on Refactoring");
      }

      const studentId = userData.users[0].id;
      console.log("Found StudentId:", studentId);

      // Step 2: Get user details
      const response = await fetch(`https://developers.teachable.com/v1/users/${studentId}`, {
        method: "GET",
        headers: {
          "accept": "application/json",
          "apiKey": apiKey
        }
      });

      if (!response.ok) {
        throw new Error("API request failed: " + response.status);
      }

      const data = await response.json();
      console.log("User detail data:", data);

      const courses = (data.courses || []).filter(c => c.is_active_enrollment);

      if (!courses.length) {
        container.innerHTML = `
          No enrollments found for ${loginEmail}. 
          Consider getting this Free Course!
          <a href="https://www.iamtimcorey.com/courses/hands-on-refactoring/" target="_blank">
            Hands on Refactoring
          </a>`;
        return;
      }

      // Sort courses by progress
      courses.sort((a, b) => b.percent_complete - a.percent_complete);

      // Build table (no Action column)
      let tableHtml = `<table border="1" cellpadding="5">
        <tr><th>Course ID</th><th>Course Name</th><th>Progress</th></tr>`;
      courses.slice(0, 30).forEach(c => {
        tableHtml += `<tr>
          <td>${c.course_id}</td>
          <td>${c.course_name}</td>
          <td>${c.percent_complete}%</td>
        </tr>`;
      });
      tableHtml += "</table>";

      container.innerHTML = tableHtml;
    } catch (error) {
      console.error("An error occurred:", error);
      container.innerHTML = `Error looking up user: ${error.message}`;
    }finally {
      spinner.style.display = "none"; // hide spinner always at the end
    }
  }

  // Attach button event
  document.getElementById("loadBtn").addEventListener("click", loadCourses);

  // Attach Enter key event
  emailInput.addEventListener("keypress", (event) => {
    if (event.key === "Enter") {
      event.preventDefault();
      loadCourses();
    }
  });

  // ✅ Auto-load if URL had an email
  if (urlEmail) {
    loadCourses();
  }
});
</script>




</body>
</html>